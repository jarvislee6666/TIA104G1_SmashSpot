<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>全部場館列表 - listAllCourtOrders.html</title>
<th:block th:replace="back-end/adm/Header :: headContent" />
<head th:insert="~{/back-end/adm/included-fragment}"></head>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
</style>
<body>

	<div class="loading-overlay">
		<div class="loading-spinner"></div>
	</div>

	<!-- Navbar -->
	<header th:replace="back-end/adm/Header :: header"></header>

	<div class="container-fluid">
		<div class="row">
			<div class="col-md-2 mb-4">
				<div class="card">
					<div class="card-body p-0">
						<div class="nav flex-column nav-pills">
							<a class="nav-link" th:href="@{/adm/addStdm}"> <i
								class="fas fa-plus-circle me-2"></i>場館刊登
							</a> <a class="nav-link" th:href="@{/adm/listAllStdm}"> <i
								class="fas fa-list me-2"></i>場館刊登列表
							</a> <a class="nav-link active" th:href="@{/adm/listAllCourtOrders}"> <i class="fas fa-history me-2"></i>預約訂單紀錄
							</a> <a class="nav-link" href="#"> <i
								class="fas fa-chart-line me-2"></i>場館成效統計
							</a>
						</div>
					</div>
				</div>
			</div>

			<!-- 主要內容區 -->
			<div class="col-md-10">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title">預約訂單紀錄</h5>
                        </div>
                        
                        <div class="search-section mb-4">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" placeholder="場地名稱">
                                </div>
                                <div class="col-md-3">
                                    <input type="date" class="form-control" placeholder="預約日期">
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control" placeholder="預約人ID">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">搜尋</button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>場地ID</th>
                                        <th>預約人ID</th>
                                        <th>預約金額</th>
                                        <th>預約狀態</th>
                                        <th>球場星等</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>    
								    <tr th:each="orderList : ${orderList}">
										<td th:text="${orderList.courtordid}"></td>
										<td th:text="${orderList.stadium.stdmName}"></td>
										<td th:text="${orderList.member.account}"></td>
										<td th:text="${orderList.totamt}"></td>			
										<td th:text="${orderList.ordsta ? '已預約' : '已取消'}"></td>			
										<td th:text="${orderList.starrank}"></td>
										<td>
                                            <button class="btn btn-sm btn-outline-primary view-details" data-bs-toggle="modal" data-bs-target="#orderModal" th:attr="data-order-id=${orderList.courtordid}">>
                                                查看詳情
                                            </button>
                                        </td>
									</tr>
                                </tbody>
                            </table>

                            <div class="d-flex justify-content-between align-items-center mt-4">
                                
                                <div class="col-md-4 d-flex justify-content-center">
                                    <nav>
                                        <ul class="pagination mb-0">
                                            <li class="page-item">
                                                <a class="page-link" href="#" aria-label="Previous">
                                                    <span aria-hidden="true">&laquo;</span>
                                                </a>
                                            </li>
                                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                                            <li class="page-item">
                                                <a class="page-link" href="#" aria-label="Next">
                                                    <span aria-hidden="true">&raquo;</span>
                                                </a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                                <div class="col-md-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 訂單詳情彈窗 -->
    <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">訂單詳情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>訂單編號</h6>
                    <p id="modalOrderId"></p>
                </div>
                
                <div class="mb-3">
                    <h6>會員資訊</h6>
                    <p id="modalMemberId" class="mb-1"></p>
                </div>

                <div class="mb-3">
                    <h6>場館資訊</h6>
                    <p id="modalVenueName"></p>
                </div>

                <div class="mb-3">
                    <h6>預約詳情</h6>
                    <div id="modalBookingDetails"></div>
                    <p id="modalTotalAmount"></p>
                </div>

                <div class="mb-3">
                    <h6>訂單狀態</h6>
                    <p class="order-status">
                        <span id="modalOrderStatus"></span>
                    </p>
                    <p id="modalStarRating" class="mb-1"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', function() {
    const orderList = /*[[${orderList}]]*/ [];
    
    document.querySelectorAll('.view-details').forEach(button => {
        button.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            const row = this.closest('tr');
            
            // 從表格行獲取資料
            document.getElementById('modalOrderId').textContent = 
                'ORD' + orderId.padStart(6, '0');
            document.getElementById('modalMemberId').textContent = 
                '會員 ID：' + row.children[2].textContent;
            document.getElementById('modalVenueName').textContent = 
                row.children[1].textContent;
            document.getElementById('modalTotalAmount').textContent = 
                '總金額：NT$ ' + row.children[3].textContent;
            
            const isReserved = row.children[4].textContent === '已預約';
            const statusSpan = document.getElementById('modalOrderStatus');
            statusSpan.textContent = isReserved ? '已預約' : '已取消';
            statusSpan.className = 'status-badge ' + 
                (isReserved ? 'status-reserved' : 'status-canceled');
            
            const starRating = row.children[5].textContent;
            document.getElementById('modalStarRating').textContent = 
                starRating ? `評價星等：${starRating}` : '';
            
            // 使用 AJAX 獲取訂單詳情（如預約日期和時段）
            fetch(`/adm/getOrderDetail/${orderId}`)
                .then(response => response.json())
                .then(data => {
                    const bookingDetails = document.getElementById('modalBookingDetails');
                    bookingDetails.innerHTML = '';
                    
                    if (data.courtOrderDetail && data.courtOrderDetail.length > 0) {
                        data.courtOrderDetail.forEach(detail => {
                            const detailDiv = document.createElement('div');
                            detailDiv.innerHTML = `
                                <p class="mb-1">預約日期：${new Date(detail.ordDate).toLocaleDateString('zh-TW')}</p>
                                <p class="mb-1">預約時段：${detail.ordTime}</p>
                            `;
                            bookingDetails.appendChild(detailDiv);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('modalBookingDetails').innerHTML = 
                        '<p>無法載入預約詳情</p>';
                });
        });
    });
});
</script>

</body>
</html>