<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客服聊天室</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-content {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-buttons {
            display: flex;
            gap: 1rem;
        }
        .chat-container {
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .messages-box {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }
        .message {
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            max-width: 75%;
        }
        .message-sent {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        .message-received {
            background: #e9ecef;
            margin-right: auto;
        }
        .chat-input {
            padding: 1rem;
            background: white;
            border-top: 1px solid #dee2e6;
        }
        .timestamp {
            font-size: 0.75rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- 導航欄 -->
    <header>
        <nav class="navbar navbar-light mb-4">
            <div class="container-fluid">
                <div class="navbar-content">
                    <a class="navbar-brand" href="#">管理員後台</a>
                    <div class="nav-buttons">
                        <a class="nav-link" th:href="@{/adm/listAllAdm}">
                            <i class="fas fa-users me-2"></i>員工帳號管理
                        </a>
                        <a class="nav-link" th:href="@{/adm/listAllCoupon}">
                            <i class="fas fa-ticket-alt me-2"></i>優惠券管理
                        </a>
                        <a class="nav-link" href="#">
                            <i class="fas fa-store me-2"></i>商城管理
                        </a>
                        <a class="nav-link" th:href="@{/adm/listAllStdm}">
                            <i class="fas fa-map-marker-alt me-2"></i>場地管理
                        </a>
                        <a class="nav-link" href="#">
                            <i class="fas fa-comments me-2"></i>論壇管理
                        </a>
                        <a class="nav-link active" href="#">
                            <i class="fas fa-headset me-2"></i>客服中心
                        </a>
                        <a class="nav-link" href="#">
                            <i class="fas fa-user-circle me-2"></i>會員帳號管理
                        </a>
                    </div>
                    <div class="d-flex align-items-center border-start ps-4">
                        <div class="nav-item me-3">
                            <span class="nav-link">
                                <i class="fas fa-user me-1"></i>
                                <span th:if="${session.loginAdm}" th:text="${session.loginAdm.admname}"></span>
                            </span>
                        </div>
                        <form th:action="@{/adm/logout}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-sign-out-alt me-1"></i>登出
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card chat-container">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">客服聊天室</h5>
                        <small th:text="${session.loginAdm.admname}"></small>
                    </div>
                    
                    <div class="messages-box" id="messagesBox">
                        <!-- 歷史訊息將在這裡動態載入 -->
                        <div th:each="message : ${chatMessages}" 
                             th:class="${message.sender.memid == session.loginAdm.admid} ? 'message message-sent' : 'message message-received'">
                            <div class="message-content" th:text="${message.content}"></div>
                            <div class="timestamp" th:text="${#dates.format(message.timestamp, 'yyyy-MM-dd HH:mm')}"></div>
                        </div>
                    </div>

                    <div class="chat-input">
                        <form id="messageForm" class="d-flex">
                            <input type="text" 
                                   id="messageInput" 
                                   class="form-control me-2" 
                                   placeholder="輸入訊息..."
                                   required>
                            <button type="submit" class="btn btn-primary">發送</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script th:inline="javascript">
        // 獲取當前用戶信息
        const currentuser = {
    			memid: `${session.LoginAdm.admid}`,
    			name: `${session.LoginAdm.name}`
		};
        
        // WebSocket 連接
        const ws = new WebSocket(`ws://${window.location.host}/adm/websocket/chat/${currentUser.name}`);
        
        // 處理WebSocket連接建立
        ws.onopen = () => {
            console.log('WebSocket 連接已建立');
            // 載入歷史訊息
            loadChatHistory();
        };

        // 處理接收到的訊息
        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            appendMessage(message);
        };

        // 處理WebSocket錯誤
        ws.onerror = (error) => {
            console.error('WebSocket 錯誤:', error);
        };

        // 處理WebSocket連接關閉
        ws.onclose = () => {
            console.log('WebSocket 連接已關閉');
        };

        // 載入歷史訊息
        function loadChatHistory() {
            fetch(`/messages/${currentUser.memid}/Adm`)
                .then(response => response.json())
                .then(messages => {
                    messages.forEach(message => appendMessage(message));
                    scrollToBottom();
                })
                .catch(error => console.error('Error loading chat history:', error));
        }

        // 發送訊息
        document.getElementById('messageForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (content) {
                const message = {
                    sender: {
                        memid: currentUser.memid,
                        name: currentUser.name
                    },
                    recipientId: 'Adm',
                    content: content,
                    timestamp: new Date()
                };

                ws.send(JSON.stringify(message));
                input.value = '';
                appendMessage(message);
                scrollToBottom();
            }
        });

        // 添加訊息到聊天窗口
        function appendMessage(message) {
            const messagesBox = document.getElementById('messagesBox');
            const messageDiv = document.createElement('div');
            const isCurrentUser = message.sender.memid === currentUser.memid;
            
            messageDiv.className = isCurrentUser ? 'message message-sent' : 'message message-received';
            
            messageDiv.innerHTML = `
                <div class="message-content">${message.content}</div>
                <div class="timestamp">${new Date(message.timestamp).toLocaleString()}</div>
            `;
            
            messagesBox.appendChild(messageDiv);
            scrollToBottom();
        }

        // 滾動到最新訊息
        function scrollToBottom() {
            const messagesBox = document.getElementById('messagesBox');
            messagesBox.scrollTop = messagesBox.scrollHeight;
        }
    </script>
</body>
</html>