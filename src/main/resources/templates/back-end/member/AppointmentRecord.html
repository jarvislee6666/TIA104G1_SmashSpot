<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>場地預約紀錄</title>
<th:block th:replace="back-end/client/Header :: headContent" />
<link rel="stylesheet" th:href="@{/css/client/Header.css}" />
<link rel="stylesheet" th:href="@{/css/client/Footer.css}" />
<link rel="stylesheet" th:href="@{/css/client/Sidebar.css}" />
<style>
html, body {
	height: 100%;
	margin: 0;
	padding: 0;
}

body {
	display: flex;
	flex-direction: column;
	min-height: 100vh;
}

main {
	margin-top: 9rem;
	flex: 1 0 auto;
}

.product-img {
	width: 100px;
	height: 100px;
	object-fit: cover;
	border: 1px solid #dee2e6;
}

th {
	background-color: #f8f9fa;
	padding: 12px;
	border-bottom: 2px solid #dee2e6;
}

td {
	padding: 12px;
	vertical-align: middle;
	border-bottom: 1px solid #dee2e6;
}

.main-title {
	font-size: 20px;
	color: #333;
	margin-bottom: 16px;
}

.category-container {
	background: white;
	border-radius: 8px;
	padding: 16px;
	box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
	margin-bottom: 16px;
}

.sub-title {
	font-size: 16px;
	color: #666;
	margin-bottom: 12px;
}

category-list {
	background: white;
	border-radius: 8px;
	overflow: hidden;
	box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.category-item {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 12px 16px;
	color: #333;
	text-decoration: none;
	border-bottom: 1px solid #f0f0f0;
}

.category-item:last-child {
	border-bottom: none;
}

.category-item.active {
	background-color: #0d6efd;
	color: white;
}

.badge-number {
	background: #0d6efd;
	color: white;
	padding: 2px 8px;
	border-radius: 12px;
	font-size: 14px;
}

.active .badge-number {
	background: white;
	color: #0d6efd;
}

.category-title {
	font-size: 16px;
	color: #666;
	margin: 0 0 8px 4px;
}

.action-button {
	width: 100%;
	padding: 8px;
	margin-bottom: 8px;
	border: 1px solid #0d6efd;
	border-radius: 4px;
	background: white;
	color: #0d6efd;
	display: flex;
	align-items: center;
	justify-content: center;
	gap: 8px;
	text-decoration: none;
}

.action-button:hover {
	background-color: #f8f9fa;
	color: #0d6efd;
	text-decoration: none;
}

/* ======================= 預約記錄 ================================= */
.star {
	cursor: pointer;
	color: #ddd;
	font-size: 2rem;
	transition: color 0.2s;
}

.star.active {
	color: #ffc107; /* Bootstrap's warning color for stars */
}

.ql-editor {
	font-family: inherit;
	font-size: inherit;
	color: inherit;
}

.section-title {
	color: #333;
	font-size: 1.1rem;
	font-weight: 600;
	padding-bottom: 0.5rem;
	border-bottom: 2px solid #eee;
}

.info-section {
	padding: 0.5rem;
}

#detailDateTime, #detailMessage {
	min-height: 60px;
	/* 	white-space: pre-wrap; */
}

.min-vh-10 {
	min-height: 10vh;
}

.booking-block {
	margin-bottom: 30px; /* 增加區塊間的間距 */
	line-height: 0.1; /* 修正行高 */
}

/* 第一個 booking-block 不留額外空間 */
.booking-block:first-of-type {
	margin-top: 0;
}

.booking-date, .booking-time {
	padding: 2px 0;
	line-height: 1.5; /* 確保文字不會重疊 */
	white-space: normal; /* 允許文字正常換行 */
}

/* 新增樣式處理時段的排版 */
.time-ranges {
	margin-left: 15px; /* 縮排效果 */
	line-height: 1.5; /* 確保時段文字不重疊 */
}

.font-family-inherit {
	font-family: inherit;
}

.font-size-inherit {
	font-size: inherit;
}

.text-color-inherit {
	color: inherit;
}

/* 假如你想要讓 textarea 有更好的調整空間，可以再補充一些樣式 */
textarea {
	width: 100%;
	min-height: 100px;
	resize: vertical; /* 讓使用者可以垂直拉伸 */
}
</style>
</head>

<body class="bg-light">

	<div th:replace="back-end/client/Header :: header"></div>

	<main>
		<div class="container position-relative mb-3">
			<div class="row">
				<!-- Sidebar -->
					<div class="col-md-3">
					  <div class="card border-0 shadow-sm">
					    <div class="card-body p-4">
					      <h5 class="fw-bold mb-4">會員專區</h5>
					      
					      <div class="d-flex flex-column gap-2">
					        <a th:href="@{/member/basic-info}" 
					           class="sidebar-link d-flex align-items-center gap-2 p-2 rounded text-decoration-none">
					          <i class="bi bi-person-circle"></i>
					          <span>基本資料</span>
					        </a>
					        
					        <a th:href="@{/member/biddingList}"
					           class="sidebar-link d-flex align-items-center gap-2 p-2 rounded text-decoration-none">
					          <i class="bi bi-hammer"></i>
					          <span>參加中競標</span>
					        </a>
					        
					        <a th:href="@{/member/buyingList}"
					           class="sidebar-link d-flex align-items-center gap-2 p-2 rounded text-decoration-none">
					          <i class="bi bi-bag-check"></i>
					          <span>購買清單</span>
					        </a>
					        
					        <a th:href="@{/member/appointment-records}"
					           class="sidebar-link d-flex align-items-center gap-2 p-2 rounded text-decoration-none">
					          <i class="bi-calendar-check"></i>
					          <span>場地預約紀錄</span>
					        </a>
					      </div>
					    </div>
					  </div>
					</div>

				<!-- Main Content -->
				<div class="col-md-9">
					<h2 class="mb-3">預約紀錄</h2>

					<div class="table-responsive">
						<table class="table table-striped table-bordered">
							<thead>
								<tr>
									<th>#</th>
									<th>場地名稱</th>
									<th>預約時段數量</th>
									<th>預約金額</th>
									<th>預約狀態</th>
									<th>狀態操作</th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="order, idx : ${orders}"
									th:attr="data-ordid=${order.courtordid}">
									<!-- 第一欄: 這裡若要顯示第幾筆 -->
									<td th:text="${idx.count}">1</td>

									<!-- 第二欄: 場地名稱 -->
									<td th:text="${order.stadium.stdmName}"></td>

									<!-- 第三欄: 預約時段數量(計算好的) -->
									<td class="reserved-count"></td>

									<!-- 第四欄: 預約金額 -->
									<td th:text="${order.totamt} + ' TWD'"></td>

									<!-- 第五欄: 預約狀態 -->
									<td th:text="${order.ordsta} ? '已預約' : '已取消'"></td>

									<!-- 第六欄: 狀態操作(明細、取消按鈕) -->
									<td>
										<button type="button"
											class="btn  btn-primary btn-sm detail-btn" data-ordid="">時段明細</button>
										<button type="button"
											class="btn btn-warning btn-sm review-btn">給予評價</button>
										<button type="button" class="btn btn-danger btn-sm cancel-btn">
											取消預約</button>
									</td>
								</tr>
							</tbody>
						</table>
					</div>

					<!-- detailModal: 顯示詳細資料 -->
					<div class="modal fade" id="detailModal" tabindex="-1">
						<div class="modal-dialog modal-dialog-centered">
							<div class="modal-content">
								<div class="modal-header bg-light">
									<h5 class="modal-title fw-bold">預約詳細資訊</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
								</div>
								<div class="modal-body p-4">
									<!-- 訂單資訊區塊 -->
									<div class="info-section mb-4">
										<h6 class="section-title mb-3">訂單資訊</h6>
										<div class="row g-3">
											<div class="col-6">
												<label class="text-muted small">訂單編號</label>
												<div class="fw-medium" id="detailOrderId"></div>
											</div>
											<div class="col-6">
												<label class="text-muted small">訂單狀態</label>
												<div class="fw-medium" id="detailStatus"></div>
											</div>
										</div>
									</div>

									<!-- 預約詳情區塊 -->
									<div class="info-section mb-4">
										<h6 class="section-title mb-3">預約詳情</h6>
										<div class="mb-3">
											<label class="text-muted small">預約時段</label>
											<div class="p-1 bg-light rounded" id="detailDateTime"></div>
										</div>
										<div>
											<label class="text-muted small">總金額</label>
											<div class="fw-bold text-primary">
												<span id="detailTotalAmt"></span> TWD
											</div>
										</div>
									</div>

									<!-- 評價資訊區塊 -->
									<div class="info-section">
										<h6 class="section-title mb-3">評價資訊</h6>
										<div class="mb-3">
											<label class="text-muted small">星等評價</label>
											<div class="text-warning fs-5" id="detailStar"></div>
										</div>
										<div>
											<label class="text-muted small">評價留言</label>
											<div class="p-3 bg-light rounded min-vh-10"
												id="detailMessage"></div>
										</div>
										<div>
											<label class="text-muted small">取消原因</label>
											<div class="p-3 bg-light rounded min-vh-10"
												id="detailcanreason"></div>
										</div>
									</div>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-secondary"
										data-bs-dismiss="modal">關閉</button>
								</div>
							</div>
						</div>
					</div>
					<!-- End detailModal -->

					<!--  給予評價彈窗 -->
					<div id="reviewModal" class="modal fade" tabindex="-1">
						<div class="modal-dialog modal-dialog-centered">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title">給予評價</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
								</div>
								<div class="modal-body">
									<p>滿意本次的預約嗎? 請給予場館評價並留下意見回饋...</p>

									<div class="mb-3 d-flex align-items-center">
										<label class="me-2">評價場館</label>
										<div id="star-rating" class="d-flex">
											<span class="star" data-rating="1">★</span> <span
												class="star" data-rating="2">★</span> <span class="star"
												data-rating="3">★</span> <span class="star" data-rating="4">★</span>
											<span class="star" data-rating="5">★</span>
										</div>
									</div>

									<div class="mb-3">
										<label>留言評論</label>
										<textarea id="review-comment" class="form-control"
											placeholder="請在此輸入..."></textarea>
									</div>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-secondary"
										data-bs-dismiss="modal">取消</button>
									<button type="button" class="btn btn-primary"
										id="sendReviewBtn">送出評價</button>
								</div>
							</div>
						</div>
					</div>


					<!-- 取消預約彈窗 -->
					<div class="modal fade" id="cancelModal" tabindex="-1"
						aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered">
							<div class="modal-content">
								<div class="modal-body">
									<p>頻繁取消預約將影響您後續進行其他預約的權益，請於下方說明取消該筆預約的原因...</p>
									<div class="mb-3">
										<label for="cancel-reason">取消原因</label>
										<textarea id="cancel-reason" class="form-control"
											placeholder="請在此輸入..."></textarea>
									</div>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-secondary"
										data-bs-dismiss="modal">再想想</button>
									<button type="button" class="btn btn-danger"
										id="confirmCancelBtn">確定取消</button>
								</div>
							</div>
						</div>
					</div>

					<!-- /彈窗結束 -->
				</div>
			</div>
		</div>
	</main>

	<div th:replace="back-end/client/Footer :: footer"></div>

	<!-- JS 區 -->
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

	<script th:inline="javascript">
  // --- (A) RWD Navbar (原程式) ---
  document.addEventListener("DOMContentLoaded", function () {
    const toggleBtn = document.querySelector(".navbar-toggler");
    const navList = document.querySelector(".nav-list");
    toggleBtn.addEventListener("click", function () {
      navList.classList.toggle("show");
    });
  });

  // --- (B) 星星評分相關 ---
  // 這裡定義一個全域變數來記錄當前評分
  let currentRating = 0;

  document.addEventListener("DOMContentLoaded", function () {
    const starRatingContainer = document.getElementById("star-rating");
    if(starRatingContainer){
      const stars = Array.from(starRatingContainer.querySelectorAll(".star"));
      
      // 清空所有 star
      function clearStars() {
        stars.forEach((star) => star.classList.remove("active"));
      }
      // 設置指定數量的 star 為 active
      function setStars(rating) {
        clearStars();
        stars.slice(0, rating).forEach((star) => star.classList.add("active"));
        currentRating = rating;
      }
      // 綁定每顆星星的點擊事件
      stars.forEach((star) => {
        star.addEventListener("click", function () {
          const rating = parseInt(this.getAttribute("data-rating"));
          setStars(rating);
        });
      });
    }
  });

  // --- (C) 使用 jQuery 做 AJAX ---
  $(document).ready(function() {

    // 1) 監聽「給評價」按鈕點擊 => 打開評價Modal
    $(".review-btn").on("click", function() {
      // 從所在的 <tr> 取得 courtordid
      const courtordid = $(this).closest("tr").attr("data-ordid");
      if (!courtordid) {
        alert("無法取得訂單編號 (courtordid)");
        return;
      }
      // 清理評論輸入欄、星星
      resetReviewModal();

      // 「送出評價」按鈕點擊 => 呼叫後端 PATCH
      $("#sendReviewBtn").off("click").on("click", function() {
        const rating = currentRating; // 全域變數
        const message = $("#review-comment").val().trim();
        if (rating === 0 && !message) {
          alert("請至少給星等或填寫一些留言！");
          return;
        }

        $.ajax({
          url: `/court-order/review/${courtordid}`,  // 依你後端路由
          method: "PATCH",
          contentType: "application/json",
          data: JSON.stringify({
            starrank: rating,
            message: message
          }),
          success: function(resp) {
            if (resp.success) {
              alert("評價已更新");
              // 可加上刷新頁面 or 更新畫面顯示
              window.location.reload();
              $("#reviewModal").modal("hide");
            } else {
              alert("評價失敗: " + resp.message);
            }
          },
          error: function(err) {
            console.error(err);
            alert("呼叫評價 API 失敗");
          }
        });
      });

      // 打開 Modal
      const reviewModal = new bootstrap.Modal(document.getElementById("reviewModal"));
      reviewModal.show();
    });

    // 2) 監聽「取消預約」按鈕點擊 => 打開取消Modal
    $(".cancel-btn").on("click", function() {
      const courtordid = $(this).closest("tr").attr("data-ordid");
      if (!courtordid) {
        alert("無法取得訂單編號 (courtordid)");
        return;
      }
      // 清空原因欄
      $("#cancel-reason").val("");

      // 確定取消 => PATCH
      $("#confirmCancelBtn").off("click").on("click", function() {
        const reason = $("#cancel-reason").val().trim();
        if (!reason) {
          alert("請輸入取消原因");
          return;
        }

        $.ajax({
          url: `/court-order/cancel/${courtordid}`,
          method: "PATCH",
          contentType: "application/json",
          data: JSON.stringify({
            ordsta: false,       // 訂單改為 false
            canreason: reason    // 寫入取消原因
          }),
          success: function(resp) {
            if (resp.success) {
              alert("訂單已取消");
              window.location.reload();
              $("#cancelModal").modal("hide");
            } else {
              alert("取消失敗: " + resp.message);
            }
          },
          error: function(err) {
            console.error(err);
            alert("呼叫取消 API 失敗");
          }
        });
      });

      // 打開 Modal
      const cancelModal = new bootstrap.Modal(document.getElementById("cancelModal"));
      cancelModal.show();
    });

    // 3) 解析「預約紀錄」的 AJAX (原本就有)
    const TIME_RANGES = [
      "X(不開放)","X(不開放)","X(不開放)","X(不開放)",
      "08:00~10:00","10:00~12:00","12:00~14:00",
      "14:00~16:00","16:00~18:00","18:00~20:00",
      "20:00~22:00","X(不開放)"
    ];

    // 假設後端 thymeleaf 有放 memId
    const memId = /*[[${memId}]]*/

    $.ajax({
      url:`http://localhost:8080/court-order/my-orders/${memId}`, 
      type: "GET",
      dataType: "json",
      success: function(response) {
        console.log("後端回傳(含明細 ord_time):", response);

        response.forEach(function(order) {
          // 找到對應 <tr>
          const rowSelector = `tr[data-ordid='${order.courtordid}']`;
          let $row = $(rowSelector);

          // (a) 計算總時段數量
          let totalReservedSlots = 0;
          (order.courtOrderDetail || []).forEach(function(dtl) {
            let ordTimeStr = dtl.ordTime;
            for (let i = 0; i < ordTimeStr.length; i++) {
              if (ordTimeStr.charAt(i) === '1') {
                totalReservedSlots++;
              }
            }
          });
          $row.find(".reserved-count").text(totalReservedSlots);

          // (b) 填入 時段文字
          let details = order.courtOrderDetail || [];
          let finalTimeStr = "";
          details.forEach(function(dtl, idx) {
            let ordTimeStr = dtl.ordTime;
            let reservedTimeArr = [];
            for (let i = 0; i < ordTimeStr.length; i++) {
              if (ordTimeStr.charAt(i) === '1') {
                reservedTimeArr.push(TIME_RANGES[i]);
              }
            }
            let reservedTimeText = reservedTimeArr.join("、");
            finalTimeStr += `${dtl.ordDate} ${reservedTimeText}`;
            if(idx < details.length - 1){
              finalTimeStr += " / ";
            }
          });
          $row.find(".json-reserveTime").text(finalTimeStr);

          // (c) 綁定「詳細」按鈕的 order 資料
          $row.find(".detail-btn").data("order", order);
        });

        // (d) detail-btn => 開 detailModal
        $(".detail-btn").on("click", function(){
          const order = $(this).data("order");
          if(!order){
            alert("無法取得訂單詳細資料");
            return;
          }
          openDetailModal(order);
        });
      },
      error: function(xhr, status, error) {
        console.error("查詢預約紀錄失敗:", error);
      }
    });


    // 打開 detailModal, 填資料
    function openDetailModal(order){
      // 例如會員資料
      let memberName = (order.member && order.member.name) || "未知";
      let memberEmail= (order.member && order.member.email) || "unknown@example.com";
      let memberPhone= (order.member && order.member.phone) || "N/A";
      // 場館
      let stadiumName= (order.stadium && order.stadium.stdmName) || "未知場館";

      // 組合時段顯示
      let dateTimeStr = "";
      (order.courtOrderDetail||[]).forEach(function(dtl, idx){
        let ordTimeStr = dtl.ordTime;
        let reservedTimeArr = [];
        for(let i=0; i<ordTimeStr.length; i++){
          if(ordTimeStr.charAt(i)==='1'){
            reservedTimeArr.push(TIME_RANGES[i]);
          }
        }
        dateTimeStr += `
          <div class="booking-block">
            <div class="booking-date" style="color: #dc3545; font-weight: bold;">日期：${dtl.ordDate}</div>
            <div class="booking-time">時段：${reservedTimeArr.join('、')}</div>
          </div>`;
      });

      // 星等顯示
      let starRank= order.starrank || 0;
      let starHtml= "";
      for(let i=0; i<starRank; i++){
        starHtml+= "★";
      }
      for(let i=starRank; i<5; i++){
        starHtml+= "☆";
      }

      // 放到 modal
      $("#detailOrderId").text(order.courtordid);
      $("#detailMemberName").text(memberName);
      $("#detailMemberEmail").text(memberEmail);
      $("#detailMemberPhone").text(memberPhone);
      $("#detailStadiumName").text(stadiumName);
      $("#detailDateTime").html(dateTimeStr);
      $("#detailTotalAmt").text(order.totamt||0);
      $("#detailStatus").text(order.ordsta ? "已預約" : "已取消");
      $("#detailStar").text(starHtml);
      $("#detailMessage").text(order.message || "");
      $("#detailcanreason").text(order.canreason || "");

      // 彈出
      let detailModal = new bootstrap.Modal(document.getElementById("detailModal"));
      detailModal.show();
    }

    // 小工具: 清空評價Modal
    function resetReviewModal() {
      currentRating = 0;
      // 移除所有 star active
      $("#star-rating .star").removeClass("active");
      // 清空文字
      $("#review-comment").val("");
    }
  });
</script>

</body>
</html>
