<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>çƒå ´é ç´„ç³»çµ±</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
	rel="stylesheet">
<style>
body {
	margin: 0;
	font-family: sans-serif;
}

.status-available {
	background-color: rgba(13, 110, 253, 0.1);
	color: #0d6efd;
}

.status-limited {
	background-color: rgba(255, 193, 7, 0.1);
	color: #ffc107;
}

.status-full {
	background-color: rgba(220, 53, 69, 0.1); /* ç´…è‰²èª¿ */
	color: #dc3545;
}

.status-reserve {
	background-color: #f9e8f4ea !important;
	color: #fe0391;
}

.status-unavailable {
	background-color: rgba(108, 117, 125, 0.1);
	color: #6c757d;
}

.court-cell {
	cursor: pointer;
	transition: transform 0.2s;
	border-radius: 4px;
	padding: 10px;
}

.court-cell:hover {
	transform: scale(1.05);
}

.court-cell.selected {
	outline: 2px solid #0d6efd;
}
</style>
</head>
<body>


	<div id="stadiumInfo" th:data-stdmId="${stdmId}" style="display: none;"></div>
	<!-- å¤–å±¤ container ä¾†æ§åˆ¶æ•´é«”å¯¬åº¦å’Œé‚Šè· -->
	<div class="container-fluid px-3">
		<!-- ç¬¬ä¸€å€‹ rowï¼šé€±æ›†å°è¦½å¡ç‰‡ -->
		<div class="row mb-3">
			<div class="col-12">
				<div class="card">
					<div class="card-body">
						<div class="d-flex align-items-center justify-content-between">
							<h2 class="card-title text-primary  mb-0 fw-bold"
								th:text="${stdmName}"></h2>

							<div class="d-flex align-items-center">
								<a th:if="${week > 0}" class="btn btn-outline-primary me-2"
									th:href="@{/reservation/week(stdmId=${stdmId}, week=${week - 1})}">
									ä¸Šä¸€é€± </a> <a th:if="${week <= 0}"
									class="btn btn-outline-primary me-2 disabled" href="#"> ä¸Šä¸€é€±
								</a> <span class="px-3 fw-medium"
									th:text="${#dates.format(startDate, 'yyyy/MM/dd')} + ' ~ ' + ${#dates.format(endDate, 'yyyy/MM/dd')}">
								</span> <a th:if="${week < 4}" class="btn btn-outline-primary ms-2"
									th:href="@{/reservation/week(stdmId=${stdmId}, week=${week + 1})}">
									ä¸‹ä¸€é€± </a> <a th:if="${week >= 4}"
									class="btn btn-outline-primary ms-2 disabled" href="#"> ä¸‹ä¸€é€±
								</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- ç¬¬äºŒå€‹ rowï¼šå ´åœ°è³‡è¨Šå’Œé ç´„è¡¨æ ¼ -->
		<div class="row">
			<!-- å·¦å´ï¼šå ´åœ°è³‡è¨Šå¡ç‰‡ col-md-3 -->
			<div class="col-md-3">
				<div class="card custom-shadow mb-3">
					<div class="card-body">
						<h5
							class="card-title text-primary border-bottom pb-2 mb-3 fw-bold">
							å ´åœ°è³‡è¨Š</h5>
						<div class="list-group list-group-flush">

							<div class="list-group-item d-flex align-items-center">
								<div class="info-icon">ğŸ“</div>
								<span>åœ°å€ï¼š[[${stadiumVO.stdmAddr}]]</span>
							</div>
							<div class="list-group-item d-flex align-items-center">
								<div class="info-icon">ğŸ¸</div>
								<span>å ´åœ°æ•¸é‡ï¼š[[${stadiumVO.courtCount}]]</span>
							</div>
							<div class="list-group-item d-flex align-items-center">
								<div class="info-icon">â°</div>
								<span>ç‡Ÿæ¥­æ™‚é–“ï¼š[[${stadiumVO.openTime}]]:00 -
									[[${stadiumVO.closeTime}]]:00</span>
							</div>
							<div class="list-group-item d-flex align-items-center">
								<div class="info-icon">ğŸ’°</div>
								<span>æ¯å°æ™‚è²»ç”¨ï¼šNT$ [[${stadiumVO.courtPrice}]]/å°æ™‚</span>
							</div>
							<div class="list-group-item d-flex align-items-center">
								<div class="info-icon">ğŸ‘¤</div>
								<span>å ´åœ°ç®¡ç†å“¡ï¼š[[${stadiumVO.admVO.admname}]]</span>
							</div>
							<div class="list-group-item d-flex align-items-center">
								<div class="info-icon">â„¹ï¸<br></div>
								<span>å ´é¤¨ä»‹ç´¹ï¼š[[${stadiumVO.stdmIntro}]]</span>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- å³å´ï¼šé ç´„è¡¨æ ¼ col-md-9 -->
			<div class="col-md-9">
				<div class="card">
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-bordered text-center">
								<thead>
									<tr>
										<!-- ç¬¬ä¸€æ ¼ï¼šæ™‚æ®µ -->
										<th style="width: 110px; min-width: 110px;"></th>

										<!-- Sunday æ¬„ä½ -->
										<th style="color: red;">
											<!-- å›ºå®šæ–‡å­—ï¼šSUN -->
											<div>SUN</div> <!-- å¾ reservationList[0] æ‹¿æ—¥æœŸ -->
											<div
												th:text="${#calendars.format(reservationList[0].date, 'yyyy-MM-dd')}"></div>
										</th>

										<!-- Monday æ¬„ä½ -->
										<th style="color: blue;">
											<div>MON</div>
											<div
												th:text="${#calendars.format(reservationList[1].date, 'yyyy-MM-dd')}"></div>
										</th>

										<!-- Tuesday -->
										<th style="color: blue;">
											<div>TUE</div>
											<div
												th:text="${#calendars.format(reservationList[2].date, 'yyyy-MM-dd')}"></div>
										</th>

										<!-- Wednesday -->
										<th style="color: blue;">
											<div>WED</div>
											<div
												th:text="${#calendars.format(reservationList[3].date, 'yyyy-MM-dd')}"></div>
										</th>

										<!-- Thursday -->
										<th style="color: blue;">
											<div>THU</div>
											<div
												th:text="${#calendars.format(reservationList[4].date, 'yyyy-MM-dd')}"></div>
										</th>

										<!-- Friday -->
										<th style="color: blue;">
											<div>FRI</div>
											<div
												th:text="${#calendars.format(reservationList[5].date, 'yyyy-MM-dd')}"></div>
										</th>

										<!-- Saturday -->
										<th style="color: red;">
											<div>SAT</div>
											<div
												th:text="${#calendars.format(reservationList[6].date, 'yyyy-MM-dd')}"></div>
										</th>
									</tr>
								</thead>

								<tbody>
									<!-- 08:00-10:00 -->
									<tr>
										<td class="align-middle"
											style="width: 100px; min-width: 100px;">08:00-10:00</td>
										<td th:each="resvo : ${reservationList}">
											<div
												th:with="available=${#strings.substring(resvo.leftover,4,5)},
                                        isExpired=${#dates.createNow() > resvo.date},
                                        isFuture=${resvo.date.time > futureLimit.time}"
												th:data-date="${#calendars.format(resvo.date, 'yyyy-MM-dd')}"
												th:data-time="'08:00-10:00'"
												th:data-available="${available}"
												th:class="${'court-cell ' + 
                                          (isExpired ? 'status-unavailable' : 
                                           (isFuture ? 'status-unavailable' : 
                                            (available == 'x' ? 'status-unavailable' :
                                             (available > '3' ? 'status-available' : 
                                              (available > '0' ? 'status-limited' : 'status-full')))))}">
												<div th:if="${isExpired}" class="fw-bold">å·²éæœŸ</div>
												<!-- <div th:if="${isFuture}" class="fw-bold">å°šæœªé–‹æ”¾</div> -->
												<div th:if="${available == 'x'}" class="fw-bold">å°šæœªé–‹æ”¾</div>
												<div th:if="${!isExpired && !isFuture && available != 'x'}">
													<div class="fw-bold"
														th:text="${available > '3' ? 'å……è¶³' : (available > '0' ? 'å³å°‡æ»¿å ´' : 'é ç´„é¡æ»¿')}"></div>
													<small th:text="'å‰©é¤˜ ' + ${available} + ' å ´'"></small>
												</div>
											</div>
										</td>
									</tr>

									<!-- 10:00-12:00 -->
									<tr>
										<td class="align-middle"
											style="width: 100px; min-width: 100px;">10:00-12:00</td>
										<td th:each="resvo : ${reservationList}">
											<div
												th:with="available=${#strings.substring(resvo.leftover,5,6)},
                                        isExpired=${#dates.createNow() > resvo.date},
                                        isFuture=${resvo.date.time > futureLimit.time}"
												th:data-date="${#calendars.format(resvo.date, 'yyyy-MM-dd')}"
												th:data-time="'10:00-12:00'"
												th:data-available="${available}"
												th:class="${'court-cell ' + 
                                          (isExpired ? 'status-unavailable' : 
                                           (isFuture ? 'status-unavailable' : 
                                            (available == 'x' ? 'status-unavailable' :
                                             (available > '3' ? 'status-available' : 
                                              (available > '0' ? 'status-limited' : 'status-full')))))}">
												<div th:if="${isExpired}" class="fw-bold">å·²éæœŸ</div>
												<!-- <div th:if="${isFuture}" class="fw-bold">å°šæœªé–‹æ”¾</div> -->
												<div th:if="${available == 'x'}" class="fw-bold">å°šæœªé–‹æ”¾</div>
												<div th:if="${!isExpired && !isFuture && available != 'x'}">
													<div class="fw-bold"
														th:text="${available > '3' ? 'å……è¶³' : (available > '0' ? 'å³å°‡æ»¿å ´' : 'é ç´„é¡æ»¿')}"></div>
													<small th:text="'å‰©é¤˜ ' + ${available} + ' å ´'"></small>
												</div>
											</div>
										</td>
									</tr>

									<!-- 12:00-14:00 -->
									<tr>
										<td class="align-middle"
											style="width: 100px; min-width: 100px;">12:00-14:00</td>
										<td th:each="resvo : ${reservationList}">
											<div
												th:with="available=${#strings.substring(resvo.leftover,6,7)},
                                        isExpired=${#dates.createNow() > resvo.date},
                                        isFuture=${resvo.date.time > futureLimit.time}"
												th:data-date="${#calendars.format(resvo.date, 'yyyy-MM-dd')}"
												th:data-time="'12:00-14:00'"
												th:data-available="${available}"
												th:class="${'court-cell ' + 
                                          (isExpired ? 'status-unavailable' : 
                                           (isFuture ? 'status-unavailable' : 
                                            (available == 'x' ? 'status-unavailable' :
                                             (available > '3' ? 'status-available' : 
                                              (available > '0' ? 'status-limited' : 'status-full')))))}">
												<div th:if="${isExpired}" class="fw-bold">å·²éæœŸ</div>
												<!-- <div th:if="${isFuture}" class="fw-bold">å°šæœªé–‹æ”¾</div> -->
												<div th:if="${available == 'x'}" class="fw-bold">å°šæœªé–‹æ”¾</div>
												<div th:if="${!isExpired && !isFuture && available != 'x'}">
													<div class="fw-bold"
														th:text="${available > '3' ? 'å……è¶³' : (available > '0' ? 'å³å°‡æ»¿å ´' : 'é ç´„é¡æ»¿')}"></div>
													<small th:text="'å‰©é¤˜ ' + ${available} + ' å ´'"></small>
												</div>
											</div>
										</td>
									</tr>

									<!-- 14:00-16:00 -->
									<tr>
										<td class="align-middle"
											style="width: 100px; min-width: 100px;">14:00-16:00</td>
										<td th:each="resvo : ${reservationList}">
											<div
												th:with="available=${#strings.substring(resvo.leftover,7,8)},
                                        isExpired=${#dates.createNow() > resvo.date},
                                        isFuture=${resvo.date.time > futureLimit.time}"
												th:data-date="${#calendars.format(resvo.date, 'yyyy-MM-dd')}"
												th:data-time="'14:00-16:00'"
												th:data-available="${available}"
												th:class="${'court-cell ' + 
                                          (isExpired ? 'status-unavailable' : 
                                           (isFuture ? 'status-unavailable' : 
                                            (available == 'x' ? 'status-unavailable' :
                                             (available > '3' ? 'status-available' : 
                                              (available > '0' ? 'status-limited' : 'status-full')))))}">
												<div th:if="${isExpired}" class="fw-bold">å·²éæœŸ</div>
												<!-- <div th:if="${isFuture}" class="fw-bold">å°šæœªé–‹æ”¾</div> -->
												<div th:if="${available == 'x'}" class="fw-bold">å°šæœªé–‹æ”¾</div>
												<div th:if="${!isExpired && !isFuture && available != 'x'}">
													<div class="fw-bold"
														th:text="${available > '3' ? 'å……è¶³' : (available > '0' ? 'å³å°‡æ»¿å ´' : 'é ç´„é¡æ»¿')}"></div>
													<small th:text="'å‰©é¤˜ ' + ${available} + ' å ´'"></small>
												</div>
											</div>
										</td>
									</tr>

									<!-- 16:00-18:00 -->
									<tr>
										<td class="align-middle"
											style="width: 100px; min-width: 100px;">16:00-18:00</td>
										<td th:each="resvo : ${reservationList}">
											<div
												th:with="available=${#strings.substring(resvo.leftover,8,9)},
                                        isExpired=${#dates.createNow() > resvo.date},
                                        isFuture=${resvo.date.time > futureLimit.time}"
												th:data-date="${#calendars.format(resvo.date, 'yyyy-MM-dd')}"
												th:data-time="'16:00-18:00'"
												th:data-available="${available}"
												th:class="${'court-cell ' + 
                                          (isExpired ? 'status-unavailable' : 
                                           (isFuture ? 'status-unavailable' : 
                                            (available == 'x' ? 'status-unavailable' :
                                             (available > '3' ? 'status-available' : 
                                              (available > '0' ? 'status-limited' : 'status-full')))))}">
												<div th:if="${isExpired}" class="fw-bold">å·²éæœŸ</div>
												<!-- <div th:if="${isFuture}" class="fw-bold">å°šæœªé–‹æ”¾</div> -->
												<div th:if="${available == 'x'}" class="fw-bold">å°šæœªé–‹æ”¾</div>
												<div th:if="${!isExpired && !isFuture && available != 'x'}">
													<div class="fw-bold"
														th:text="${available > '3' ? 'å……è¶³' : (available > '0' ? 'å³å°‡æ»¿å ´' : 'é ç´„é¡æ»¿')}"></div>
													<small th:text="'å‰©é¤˜ ' + ${available} + ' å ´'"></small>
												</div>
											</div>
										</td>
									</tr>

									<!-- 18:00-20:00 -->
									<tr>
										<td class="align-middle"
											style="width: 100px; min-width: 100px;">18:00-20:00</td>
										<td th:each="resvo : ${reservationList}">
											<div
												th:with="available=${#strings.substring(resvo.leftover,9,10)},
                                        isExpired=${#dates.createNow() > resvo.date},
                                        isFuture=${resvo.date.time > futureLimit.time}"
												th:data-date="${#calendars.format(resvo.date, 'yyyy-MM-dd')}"
												th:data-time="'18:00-20:00'"
												th:data-available="${available}"
												th:class="${'court-cell ' + 
                                          (isExpired ? 'status-unavailable' : 
                                           (isFuture ? 'status-unavailable' : 
                                            (available == 'x' ? 'status-unavailable' :
                                             (available > '3' ? 'status-available' : 
                                              (available > '0' ? 'status-limited' : 'status-full')))))}">
												<div th:if="${isExpired}" class="fw-bold">å·²éæœŸ</div>
												<!-- <div th:if="${isFuture}" class="fw-bold">å°šæœªé–‹æ”¾</div> -->
												<div th:if="${available == 'x'}" class="fw-bold">å°šæœªé–‹æ”¾</div>
												<div th:if="${!isExpired && !isFuture && available != 'x'}">
													<div class="fw-bold"
														th:text="${available > '3' ? 'å……è¶³' : (available > '0' ? 'å³å°‡æ»¿å ´' : 'é ç´„é¡æ»¿')}"></div>
													<small th:text="'å‰©é¤˜ ' + ${available} + ' å ´'"></small>
												</div>
											</div>
										</td>
									</tr>

									<!-- 20:00-22:00 -->
									<tr>
										<td class="align-middle"
											style="width: 100px; min-width: 100px;">20:00-22:00</td>
										<td th:each="resvo : ${reservationList}">
											<div
												th:with="available=${#strings.substring(resvo.leftover,10,11)},
                                        isExpired=${#dates.createNow() > resvo.date},
                                        isFuture=${resvo.date.time > futureLimit.time}"
												th:data-date="${#calendars.format(resvo.date, 'yyyy-MM-dd')}"
												th:data-time="'20:00-22:00'"
												th:data-available="${available}"
												th:class="${'court-cell ' + 
                                          (isExpired ? 'status-unavailable' : 
                                           (isFuture ? 'status-unavailable' : 
                                            (available == 'x' ? 'status-unavailable' :
                                             (available > '3' ? 'status-available' : 
                                              (available > '0' ? 'status-limited' : 'status-full')))))}">
												<div th:if="${isExpired}" class="fw-bold">å·²éæœŸ</div>
												<!-- <div th:if="${isFuture}" class="fw-bold">å°šæœªé–‹æ”¾</div> -->
												<div th:if="${available == 'x'}" class="fw-bold">å°šæœªé–‹æ”¾</div>
												<div th:if="${!isExpired && !isFuture && available != 'x'}">
													<div class="fw-bold"
														th:text="${available > '3' ? 'å……è¶³' : (available > '0' ? 'å³å°‡æ»¿å ´' : 'é ç´„é¡æ»¿')}"></div>
													<small th:text="'å‰©é¤˜ ' + ${available} + ' å ´'"></small>
												</div>
											</div>
										</td>
									</tr>
									<!-- å…¶ä»–æ™‚æ®µ... å¦‚æœ‰éœ€è¦å¯è¤‡è£½ -->
								</tbody>
							</table>
						</div>

						<!-- åœ–ä¾‹èªªæ˜ -->
						<div class="d-flex gap-4 mt-3 align-items-center">
							<div class="d-flex align-items-center">
								<div class="rounded me-2 status-available"
									style="width: 20px; height: 20px;"></div>
								<small>å……è¶³ (>3)</small>
							</div>
							<div class="d-flex align-items-center">
								<div class="rounded me-2 status-limited"
									style="width: 20px; height: 20px;"></div>
								<small>å³å°‡æ»¿å ´ (â‰¤3)</small>
							</div>
							<div class="d-flex align-items-center">
								<div class="rounded me-2 status-full"
									style="width: 20px; height: 20px;"></div>
								<small>é ç´„é¡æ»¿</small>
							</div>
							<!-- é ç´„æŒ‰éˆ• -->
							<div class="ms-auto" id="bookingButtonContainer">
								<button class="btn btn-primary" onclick="showBookingModal()">
									<i class="fas fa-calendar-check me-1"></i> ç¢ºèªé ç´„
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- é ç´„ Modal -->
	<div class="modal fade" id="bookingModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">ç¢ºèªé ç´„è³‡è¨Š</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body" id="bookingModalBody">
					<!-- é€™è£¡å¯æ”¾ä¸€äº›é¸å–æ˜ç´°ã€é‡‘é¡è¨ˆç®—ç­‰è³‡è¨Š... -->
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">å–æ¶ˆ</button>
					<button type="button" class="btn btn-primary"
						onclick="goNextStep()">ä¸‹ä¸€æ­¥</button>
				</div>
			</div>
		</div>
	</div>
	
	<!-- (A) ä¿¡ç”¨å¡è³‡æ–™è¼¸å…¥ Modal -->
	<div class="modal fade" id="creditCardModal">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title">ä¿¡ç”¨å¡è³‡è¨Š</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
	      </div>
	      <div class="modal-body">
	        <form id="creditCardForm">
	          <!-- ä¿¡ç”¨å¡è™Ÿ -->
	          <div class="mb-3">
	            <label for="cardNumber" class="form-label">å¡è™Ÿ</label>
	            <input type="text" class="form-control" id="cardNumber" name="cardNumber"
	                   placeholder="è«‹è¼¸å…¥ 16 ä½æ•¸å­—">
	          </div>
	          <!-- æœ‰æ•ˆæœŸé™ -->
	          <div class="mb-3">
	            <label for="cardExpiry" class="form-label">æœ‰æ•ˆæœŸé™</label>
	            <input type="text" class="form-control" id="cardExpiry" name="cardExpiry"
	                   placeholder="MM/YY">
	          </div>
	          <!-- å®‰å…¨ç¢¼ CVV -->
	          <div class="mb-3">
	            <label for="cardCvv" class="form-label">å®‰å…¨ç¢¼ (CVV)</label>
	            <input type="text" class="form-control" id="cardCvv" name="cardCvv"
	                   placeholder="3 ä½æ•¸å­—">
	          </div>
	          <!-- æŒå¡äººå§“å -->
	          <div class="mb-3">
	            <label for="cardHolder" class="form-label">æŒå¡äººå§“å</label>
	            <input type="text" class="form-control" id="cardHolder" name="cardHolder"
	                   placeholder="èˆ‡ä¿¡ç”¨å¡ç›¸åŒ">
	          </div>
	        </form>
	      </div>
	      <div class="modal-footer">
	        <!-- å–æ¶ˆ -->
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
	        <!-- ä¸‹ä¸€æ­¥: é©—è­‰ä¿¡ç”¨å¡ (è‹¥æˆåŠŸæ‰ä¸‹å–®) -->
	        <button type="button" class="btn btn-primary" onclick="validateCreditCard()">
	          ç¢ºèªä»˜æ¬¾
	        </button>
	      </div>
	    </div>
	  </div>
	</div>
	


	<script th:inline="javascript">
  		let courtPrice = /*[[${stadiumVO.courtPrice}]]*/ 0; 
  		let courtCount = /*[[${stadiumVO.courtCount}]]*/ 0;
	</script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
	function goNextStep() {
	    // 1. é—œé–‰ bookingModal
	    const bookingModal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
	    bookingModal.hide();

	    // 2. æ‰“é–‹ creditCardModal
	    const ccModal = new bootstrap.Modal(document.getElementById('creditCardModal'));
	    ccModal.show();
	}
	
	function validateCreditCard() {
	    // 1. å–å¾—ä½¿ç”¨è€…è¼¸å…¥
	    const form = document.getElementById('creditCardForm');
	    const cardNumber = form.cardNumber.value;
	    const cardExpiry = form.cardExpiry.value;
	    const cardCvv = form.cardCvv.value;
	    const cardHolder = form.cardHolder.value;

	    // 2. ç”¨ fetch é€åˆ°å¾Œç«¯ /payment-check æª¢æŸ¥
	    fetch('/court-order/payment-check', {
	        method: 'POST',
	        headers: { 'Content-Type': 'application/json' },
	        body: JSON.stringify({ 
	          cardNumber,
	          cardExpiry,
	          cardCvv,
	          cardHolder
	        })
	    })
	    .then(response => response.json())
	    .then(data => {
	        console.log("payment-check å›æ‡‰:", data);
	        if (data.success) {
	            // é€šé => call submitBooking()
	            // ä¿¡ç”¨å¡é©—è­‰é€šé => é—œé–‰ä¿¡ç”¨å¡ Modal
	            const ccModal = bootstrap.Modal.getInstance(document.getElementById('creditCardModal'));
	            ccModal.hide();

	            // â˜…â˜…â˜… é—œéµï¼šå‘¼å«ã€Œä¸‹å–®æµç¨‹ã€å‡½å¼ â˜…â˜…â˜…
	            submitBooking();
	        } else {
	            // éŒ¯èª¤ => data.messages å¯èƒ½æ˜¯é™£åˆ—
	            alert(data.messages.join("\n"));
	        }
	    })
	    .catch(err => {
	        console.error(err);
	        alert("é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
	    });
	}


    // --------------------------------------------------
    // 1. å…¨åŸŸè®Šæ•¸ & è¨­å®š
    // --------------------------------------------------
    let selectedTimeSlots = [];

    // æ™‚æ®µå°æ‡‰ leftover è£¡é¢çš„ç´¢å¼•ä½ç½® (ç¤ºç¯„å¯«æ³•)
    const timeSlotMap = {
        '08:00-10:00': 4,
        '10:00-12:00': 5,
        '12:00-14:00': 6,
        '14:00-16:00': 7,
        '16:00-18:00': 8,
        '18:00-20:00': 9,
        '20:00-22:00': 10
    };

    // --------------------------------------------------
    // 2. åˆå§‹åŒ–ï¼Œç¶å®šé»é¸äº‹ä»¶
    // --------------------------------------------------
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.court-cell').forEach(cell => {
            cell.addEventListener('click', function() {
                const available = this.dataset.available;
                const dateStr = this.dataset.date; // "2024-12-31" ç­‰æ ¼å¼
                
                const cellDate = new Date(dateStr); 
                const now = new Date(); // ç•¶å‰æ™‚é–“

                // åƒ…ç•¶å¯ç”¨æ•¸é‡ (available) > 0 æ™‚æ‰å…è¨±é»æ“Š
                if ((available > 0 && cellDate >= now)) {
                    const date = this.dataset.date;
                    const timeSlot = this.dataset.time;
                    selectTimeSlot(this, date, timeSlot, available);
                }
            });
        });
    });

    // --------------------------------------------------
    // 3. ä½¿ç”¨è€…é»é¸æ™‚æ®µ (å‹¾é¸/å–æ¶ˆ)
    // --------------------------------------------------
    function selectTimeSlot(element, date, timeSlot) {
        const isSelected = element.classList.toggle('selected');
        
        if (isSelected) {
            selectedTimeSlots.push({ date, timeSlot, count: 1 });
        } else {
            selectedTimeSlots = selectedTimeSlots.filter(
                slot => slot.date !== date || slot.timeSlot !== timeSlot
                //Array.prototype.filter(callback) æœƒä¾æ“šå›å‚³çš„å¸ƒæ—å€¼ï¼Œä¿ç•™æˆ–ä¸Ÿæ£„é™£åˆ—ä¸­çš„å…ƒç´ ï¼šcallback å›å‚³ true â†’ ä¿ç•™è©²å…ƒç´ //callback å›å‚³ false â†’ ç§»é™¤è©²å…ƒç´ 
            );
        }
        updateBookingButton();
    }

    // --------------------------------------------------
    // 4. æª¢æŸ¥æ˜¯å¦æœ‰å·²é¸æ™‚æ®µï¼Œæ§åˆ¶ã€Œç¢ºèªé ç´„ã€æŒ‰éˆ•é¡¯ç¤º
    // --------------------------------------------------
     function updateBookingButton() {
         const container = document.getElementById('bookingButtonContainer');
         container.style.display ='block' ;
     }

    // --------------------------------------------------
    // 5. é¡¯ç¤ºé ç´„è³‡è¨Š Modal
    // --------------------------------------------------
    function showBookingModal() {
        // è‹¥æ²’é¸ä»»ä½•æ™‚æ®µ
        if (selectedTimeSlots.length === 0) {
            alert("è«‹å…ˆé¸æ“‡é ç´„æ™‚æ®µï¼Œå†é€²è¡Œé ç´„ï¼");
            return; // ç›´æ¥çµæŸï¼Œä¸é¡¯ç¤º Modal
        }
        // å‹•æ…‹çµ„å‡ºæ˜ç´°åˆ—è¡¨
        let detailsHtml = "<ul class='list-group'>";
        selectedTimeSlots.forEach(slot => {
            detailsHtml += `
                <li class="list-group-item">
                    æ—¥æœŸï¼š${slot.date} <br>
                    æ™‚æ®µï¼š${slot.timeSlot}
                </li>
            `;
        });
        detailsHtml += "</ul>";
        
        // ã€Œå·²é¸æ™‚æ®µæ•¸é‡ã€*ã€ŒcourtCountã€
        let totalCount = selectedTimeSlots.length;
        // ã€Œå·²é¸æ™‚æ®µæ•¸é‡ã€*ã€ŒcourtCountã€
        let totalAmount = selectedTimeSlots.length * courtPrice;
        
        // é¡¯ç¤ºåœ¨ Modal è£¡
        detailsHtml += `
            <hr>
        	<p class="text-end fw-bold">é ç´„æ•¸é‡ï¼š${totalCount}</p>
            <p class="text-end fw-bold">ç¸½é‡‘é¡ï¼šNT$ ${totalAmount}</p>
        `;
        // --------------------------
        

        // æ”¾é€² Modal è£¡çš„å®¹å™¨
        document.getElementById("bookingModalBody").innerHTML = detailsHtml;
        const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
        modal.show();
    }

    // --------------------------------------------------
    // 6. å°è£: çµ„å‡ºå¾Œç«¯éœ€è¦çš„ JSON çµæ§‹
    // --------------------------------------------------
    function buildOrderData() {
        // 6.1 æŒ‰æ—¥æœŸåˆ†çµ„
        const groupedByDate = {};
        selectedTimeSlots.forEach(slot => {
        	const date = slot.date;
        	const timeSlot = slot.timeSlot;
            if (!groupedByDate[date]) {
                groupedByDate[date] = [];
            }
            groupedByDate[date].push(timeSlot);
        });

        // 6.2 å»ºç«‹ courtOrderDetail
        const courtOrderDetail = [];
        
        // 6.3 å°‡æ¯å€‹ date çš„æ™‚æ®µåˆä½µæˆ ordTime
        for (const [date, timeSlots] of Object.entries(groupedByDate)) {
            // ä¾‹å¦‚: é è¨­é™£åˆ—é•·åº¦ 12, å…¶ä¸­ index=0,1,2,10 å…ˆå¡« 'x'
            // å¯¦éš›ä¾ä½ çš„å¾Œç«¯ leftover é‚è¼¯è€Œå®š
            let ordTimeArray = ['x','x','x','x','0','0','0','0','0','0','0', 'x'];
            // ç´¢å¼•ä½ç½®å°æ‡‰:
            // index:  0   1   2   3   4   5   6   7   8   9   10
            // å€¼:    'x' 'x' 'x' '0' '0' '0' '0' '0' '0' '0' 'x'

            timeSlots.forEach(ts => {
                const idx = timeSlotMap[ts];  // å–å¾—è©²æ™‚æ®µå°æ‡‰çš„ç´¢å¼•
                if (typeof idx === 'number') {
                    ordTimeArray[idx] = '1';  // ä½¿ç”¨è€…é¸å–çš„æ™‚æ®µï¼Œæ¨™è¨˜ç‚º '1'
                }
            });

            // çµ„åˆæˆå­—ä¸²
            const ordTimeString = ordTimeArray.join('');

            // æ¨é€² courtOrderDetail
            courtOrderDetail.push({
                ordDate: date,
                ordTime: ordTimeString
            });
        }

        // 6.4 è®€å– stadiumId å¾ data attribute
        const stadiumInfo = document.getElementById('stadiumInfo');
		const stadiumIdFromServer = stadiumInfo.dataset.stdmid;
        return {
            memid: 1,                 // ç¯„ä¾‹: å‡è¨­æœƒå“¡ ID=1
            stadium: { stdmId: parseInt(stadiumIdFromServer) },  
            courtOrderDetail          // åŒåå±¬æ€§ï¼ŒES6 ç°¡å¯«
        };
    }

    // --------------------------------------------------
    // 7. æœ€å¾Œ: é»æ“Šã€Œç¢ºèªé ç´„ã€ => çµ„ JSON => fetch => æ¸…é™¤
    // --------------------------------------------------
    function submitBooking() {
        // æª¢æŸ¥ selectedTimeSlots
        if (selectedTimeSlots.length === 0) {
            alert("æ‚¨å°šæœªé¸å–ä»»ä½•æ™‚æ®µï¼Œè«‹é‡æ–°é¸æ“‡ï¼");
            return;
        }
        // å…ˆæŠŠ Modal é—œé–‰
        const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
        modal.hide();

        // 7.1 çµ„å‡ºè¦é€åˆ°å¾Œç«¯çš„ JSON
        const requestBody = buildOrderData();
        console.log('å³å°‡é€å¾€å¾Œç«¯:', requestBody);
        
        // 7.2 ç™¼é€ fetch è«‹æ±‚çµ¦å¾Œç«¯
        fetch('/court-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // æˆåŠŸæ‰æœ‰ courtordid / totamt
                console.log('è¨‚å–®æ–°å¢æˆåŠŸ:', data);
                alert('è¨‚å–®ç·¨è™Ÿ: ' + data.courtordid + ', é‡‘é¡: ' + data.totamt);
              } else {
                // å¤±æ•—ï¼Œæ‹¿ data.message
                alert(data.message);
              }
            
            // === é‡æ–°è¼‰å…¥æ•´å€‹é é¢ ===
            location.reload(); 
        })
        .catch(err => {
            console.log('é€£ç·šå¤±æ•—', err);
            alert('é ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼');
        });
        
        
        // 7.3 æ¸…ç©ºå‰ç«¯å·²é¸æ™‚æ®µ & å–æ¶ˆé¸å–æ¨£å¼
        selectedTimeSlots = [];
        updateBookingButton();
        document.querySelectorAll('.court-cell.selected').forEach(cell => {
            cell.classList.remove('selected');
        });
    }
</script>

</body>
</html>
